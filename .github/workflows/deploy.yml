name: Deploy

on:
  push:
    tags: ['v*.*.*']

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. Determinar Directorio Destino segÃºn el Tag
      - name: Determine Target Directory
        id: target
        run: |
          TAG="${{ github.ref_name }}"
          echo "Analizando tag: $TAG"
          
          echo "TARGET_DIR=${{ secrets.PROJECT_PATH }}" >> $GITHUB_ENV
          echo "BRANCH_NAME=main" >> $GITHUB_ENV
          echo "TAG_NAME=$TAG" >> $GITHUB_ENV

      # 4. Ejecutar comandos SSH (Nativo)
      - name: Deploy to VM via Native SSH
        run: |
          # 1. Configurar Llave SSH
          mkdir -p ~/.ssh/
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # 2. Definir Variables
          TARGET_DIR="${{ secrets.PROJECT_PATH }}"
          BRANCH_NAME="main"
          TAG_NAME="${{ github.ref_name }}"

          echo "ðŸš€ Conectando a ${{ secrets.SSH_IP_SERVER }}..."

          # 3. Ejecutar Script Remoto
          # -o StrictHostKeyChecking=no: Evita errores de verificaciÃ³n de host (known_hosts)
          # Pasamos las variables antes del comando 'bash -s'
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER_NAME }}@${{ secrets.SSH_IP_SERVER }} \
            "TARGET_DIR='$TARGET_DIR' BRANCH_NAME='$BRANCH_NAME' TAG_NAME='$TAG_NAME' bash -s" << 'EOF'
            set -e

            # Validar variables
            if [ -z "$TARGET_DIR" ]; then
              echo "âŒ Error: TARGET_DIR no definido."
              exit 1
            fi

            # Entrar al directorio
            cd "$TARGET_DIR"

            echo "ðŸš€ Usuario autenticado: $(whoami)"
            echo "ðŸ“¦ Actualizando cÃ³digo con tag: $TAG_NAME"
            echo "ðŸŒ¿ Rama a usar: $BRANCH_NAME"
            
            # Git Checkout
            git checkout "$BRANCH_NAME"
            git fetch --prune --prune-tags --force
            git fetch origin tag "$TAG_NAME"
            git checkout --force "$TAG_NAME"
            
            # Dependencias Backend
            echo "ðŸ”§ Composer Install..."
            php composer.phar install --no-interaction --prefer-dist --optimize-autoloader --no-dev
            
            # Migrar Datos
            echo "ðŸ—„ï¸ Migrando base de datos..."
            php artisan migrate --force
            
            # Limpieza de cachÃ©
            echo "ðŸ§¹ Limpieza de cachÃ©..."
            php artisan optimize
            php artisan optimize:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            if php artisan list | grep -q 'filament:optimize'; then
              php artisan filament:optimize
            fi

            # Permisos
            sudo chgrp -R www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache

            echo "âœ… Despliegue completado!"
          EOF
