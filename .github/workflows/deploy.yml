name: Deploy

on:
  push:
    tags: ['v*.*.*']

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. Determinar Directorio Destino seg√∫n el Tag
      - name: Determine Target Directory
        id: target
        run: |
          TAG="${{ github.ref_name }}"
          echo "Analizando tag: $TAG"
          
          echo "TARGET_DIR=${{ secrets.PROJECT_PATH }}" >> $GITHUB_ENV
          echo "BRANCH_NAME=main" >> $GITHUB_ENV
          echo "TAG_NAME=$TAG" >> $GITHUB_ENV

      # 4. Ejecutar comandos SSH (Nativo)
      - name: Deploy to VM via Native SSH
        run: |
          # 1. Configurar Llave SSH
          mkdir -p ~/.ssh/
          
          # Escribimos la llave asegurando que tenga un salto de l√≠nea final
          # Si el secreto ya tiene saltos de l√≠nea, printf los respetar√°.
          printf "%s\n" "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          
          # Ajuste de permisos cr√≠tico
          chmod 600 ~/.ssh/id_rsa
          
          # DEBUG: Verificar estructura del archivo (sin mostrar el contenido privado)
          echo "üîç Verificando estructura de la llave..."
          echo "Primera l√≠nea:"
          head -n 1 ~/.ssh/id_rsa
          echo "√öltima l√≠nea:"
          tail -n 1 ~/.ssh/id_rsa
          echo "N√∫mero de l√≠neas:"
          wc -l ~/.ssh/id_rsa
          
          # Validar formato con ssh-keygen
          if ! ssh-keygen -y -f ~/.ssh/id_rsa > /dev/null; then
            echo "‚ùå Error CR√çTICO: La llave SSH sigue siendo inv√°lida."
            exit 1
          fi
          
          # 2. Definir Variables
          TARGET_DIR="${{ secrets.PROJECT_PATH }}"
          BRANCH_NAME="main"
          TAG_NAME="${{ github.ref_name }}"

          echo "üöÄ Conectando a ${{ secrets.SSH_IP_SERVER }}..."

          # 3. Ejecutar Script Remoto
          # Al haber configurado la llave en ~/.ssh/id_rsa, ssh la usar√° autom√°ticamente.
          # -o StrictHostKeyChecking=no: Evita el prompt de "Are you sure you want to continue connecting?"
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER_NAME }}@${{ secrets.SSH_IP_SERVER }} \
            "TARGET_DIR='$TARGET_DIR' BRANCH_NAME='$BRANCH_NAME' TAG_NAME='$TAG_NAME' bash -s" << 'EOF'
            set -e

            # Validar variables
            if [ -z "$TARGET_DIR" ]; then
              echo "‚ùå Error: TARGET_DIR no definido."
              exit 1
            fi

            # Entrar al directorio
            git config --global --add safe.directory \"$TARGET_DIR\"
            cd "$TARGET_DIR"

            echo "üöÄ Usuario autenticado: $(whoami)"
            echo "üì¶ Actualizando c√≥digo con tag: $TAG_NAME"
            echo "üåø Rama a usar: $BRANCH_NAME"
            
            # Git Checkout
            git checkout "$BRANCH_NAME"
            git fetch --prune --prune-tags --force
            git fetch origin tag "$TAG_NAME"
            git checkout --force "$TAG_NAME"
            
            # Dependencias Backend
            echo "üîß Composer Install..."
            php composer.phar install --no-interaction --prefer-dist --optimize-autoloader --no-dev
            
            # Migrar Datos
            echo "üóÑÔ∏è Migrando base de datos..."
            php artisan migrate --force
            
            # Limpieza de cach√©
            echo "üßπ Limpieza de cach√©..."
            php artisan optimize
            php artisan optimize:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            if php artisan list | grep -q 'filament:optimize'; then
              php artisan filament:optimize
            fi

            # Permisos
            sudo chgrp -R www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache

            echo "‚úÖ Despliegue completado!"
          EOF
